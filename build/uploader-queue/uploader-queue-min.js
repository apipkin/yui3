YUI.add("uploader-queue",function(b,k){var g=b.Lang,l=b.bind,h=b.config.win,f,d,j,a,i,e;var c=function(m){this.queuedFiles=[];this.uploadRetries={};this.numberOfUploads=0;this.currentUploadedByteValues={};this.currentFiles={};this.totalBytesUploaded=0;this.totalBytes=0;c.superclass.constructor.apply(this,arguments);};b.extend(c,b.Base,{_currentState:c.STOPPED,initializer:function(m){},_uploadStartHandler:function(n){var m=n;m.file=n.target;m.originEvent=n;this.fire("uploadstart",m);},_uploadErrorHandler:function(o){var q=this.get("errorAction");var n=o;n.file=o.target;n.originEvent=o;this.numberOfUploads-=1;delete this.currentFiles[o.target.get("id")];this._detachFileEvents(o.target);o.target.cancelUpload();if(q===c.STOP){this.pauseUpload();}else{if(q===c.RESTART_ASAP){var p=o.target.get("id"),m=this.uploadRetries[p]||0;if(m<this.get("retryCount")){this.uploadRetries[p]=m+1;this.addToQueueTop(o.target);}this._startNextFile();}else{if(q===c.RESTART_AFTER){var p=o.target.get("id"),m=this.uploadRetries[p]||0;if(m<this.get("retryCount")){this.uploadRetries[p]=m+1;this.addToQueueBottom(o.target);}this._startNextFile();}}}this.fire("uploaderror",n);},_startNextFile:function(){if(this.queuedFiles.length>0){var n=this.queuedFiles.shift(),m=n.get("id"),o=this.get("perFileParameters"),p=o.hasOwnProperty(m)?o[m]:o;this.currentUploadedByteValues[m]=0;n.on("uploadstart",this._uploadStartHandler,this);n.on("uploadprogress",this._uploadProgressHandler,this);n.on("uploadcomplete",this._uploadCompleteHandler,this);n.on("uploaderror",this._uploadErrorHandler,this);n.on("uploadcancel",this._uploadCancelHandler,this);n.set("xhrHeaders",this.get("uploadHeaders"));n.set("xhrWithCredentials",this.get("withCredentials"));n.startUpload(this.get("uploadURL"),p,this.get("fileFieldName"));this._registerUpload(n);}},_registerUpload:function(m){this.numberOfUploads+=1;this.currentFiles[m.get("id")]=m;},_unregisterUpload:function(m){if(this.numberOfUploads>0){this.numberOfUploads-=1;}delete this.currentFiles[m.get("id")];delete this.uploadRetries[m.get("id")];this._detachFileEvents(m);},_detachFileEvents:function(m){m.detach("uploadstart",this._uploadStartHandler);m.detach("uploadprogress",this._uploadProgressHandler);m.detach("uploadcomplete",this._uploadCompleteHandler);m.detach("uploaderror",this._uploadErrorHandler);m.detach("uploadcancel",this._uploadCancelHandler);},_uploadCompleteHandler:function(p){this._unregisterUpload(p.target);this.totalBytesUploaded+=p.target.get("size");delete this.currentUploadedByteValues[p.target.get("id")];if(this.queuedFiles.length>0&&this._currentState===c.UPLOADING){this._startNextFile();}var o=p;o.file=p.target;o.originEvent=p;var n=this.totalBytesUploaded;b.each(this.currentUploadedByteValues,function(q){n+=q;});var m=Math.min(100,Math.round(10000*n/this.totalBytes)/100);this.fire("totaluploadprogress",{bytesLoaded:n,bytesTotal:this.totalBytes,percentLoaded:m});this.fire("uploadcomplete",o);if(this.queuedFiles.length===0&&this.numberOfUploads<=0){this.fire("alluploadscomplete");this._currentState=c.STOPPED;}},_uploadCancelHandler:function(n){var m=n;m.originEvent=n;m.file=n.target;this.fire("uploadcacel",m);},_uploadProgressHandler:function(p){this.currentUploadedByteValues[p.target.get("id")]=p.bytesLoaded;var o=p;o.originEvent=p;o.file=p.target;this.fire("uploadprogress",o);var n=this.totalBytesUploaded;b.each(this.currentUploadedByteValues,function(q){n+=q;});var m=Math.min(100,Math.round(10000*n/this.totalBytes)/100);this.fire("totaluploadprogress",{bytesLoaded:n,bytesTotal:this.totalBytes,percentLoaded:m});},startUpload:function(){this.queuedFiles=this.get("fileList").slice(0);this.numberOfUploads=0;this.currentUploadedByteValues={};this.currentFiles={};this.totalBytesUploaded=0;this._currentState=c.UPLOADING;while(this.numberOfUploads<this.get("simUploads")&&this.queuedFiles.length>0){this._startNextFile();}},pauseUpload:function(){this._currentState=c.STOPPED;},restartUpload:function(){this._currentState=c.UPLOADING;while(this.numberOfUploads<this.get("simUploads")){this._startNextFile();}},forceReupload:function(m){var n=m.get("id");if(this.currentFiles.hasOwnProperty(n)){m.cancelUpload();this._unregisterUpload(m);this.addToQueueTop(m);this._startNextFile();}},addToQueueTop:function(m){this.queuedFiles.unshift(m);},addToQueueBottom:function(m){this.queuedFiles.push(m);},cancelUpload:function(o){if(o){var q=o.get("id");if(this.currentFiles[q]){this.currentFiles[q].cancelUpload();this._unregisterUpload(this.currentFiles[q]);if(this._currentState===c.UPLOADING){this._startNextFile();}}else{for(var n=0,m=this.queuedFiles.length;n<m;n++){if(this.queuedFiles[n].get("id")===q){this.queuedFiles.splice(n,1);break;}}}}else{for(var p in this.currentFiles){this.currentFiles[p].cancelUpload();this._unregisterUpload(this.currentFiles[p]);}this.currentUploadedByteValues={};this.currentFiles={};this.totalBytesUploaded=0;this.fire("alluploadscancelled");this._currentState=c.STOPPED;}}},{CONTINUE:"continue",STOP:"stop",RESTART_ASAP:"restartasap",RESTART_AFTER:"restartafter",STOPPED:"stopped",UPLOADING:"uploading",NAME:"uploaderqueue",ATTRS:{simUploads:{value:2,validator:function(n,m){return(n>=1&&n<=5);}},errorAction:{value:"continue",validator:function(n,m){return(n===c.CONTINUE||n===c.STOP||n===c.RESTART_ASAP||n===c.RESTART_AFTER);}},bytesUploaded:{readOnly:true,value:0},bytesTotal:{readOnly:true,value:0},fileList:{value:[],lazyAdd:false,setter:function(n){var m=n;b.Array.each(m,function(o){this.totalBytes+=o.get("size");},this);return n;}},fileFieldName:{value:"Filedata"},uploadURL:{value:""},uploadHeaders:{value:{}},withCredentials:{value:true},perFileParameters:{value:{}},retryCount:{value:3}}});b.namespace("Uploader");b.Uploader.Queue=c;},"@VERSION@",{"requires":["base"]});